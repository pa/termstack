version: v1

app:
  name: "Kubernetes TUI"
  description: "Navigate Kubernetes resources with k9s-style interface"
  theme: "default"

# Start at namespaces view
start: namespaces

pages:
  # ============================================================================
  # NAMESPACES - List all namespaces
  # ============================================================================
  namespaces:
    title: "Namespaces"
    description: "List all Kubernetes namespaces"
    data:
      type: cli
      command: "kubectl"
      args: ["get", "namespaces", "-o", "json"]
      items: "$.items[*]"
      timeout: "30s"
      refresh_interval: "60s"
    view:
      type: table
      columns:
        - path: "$.metadata.name"
          display: "Name"
        - path: "$.status.phase"
          display: "Status"
        - path: "$.metadata.creationTimestamp"
          display: "Age"
          transform: "{{ value | timeago }}"
      sort:
        column: "$.metadata.name"
        order: asc
    next:
      page: pods
      context:
        namespace: "$.metadata.name"
    actions:
      - key: "p"
        name: "Pods"
        description: "View pods in namespace"
        page: pods
        context:
          namespace: "$.metadata.name"
      - key: "d"
        name: "Deployments"
        description: "View deployments in namespace"
        page: deployments
        context:
          namespace: "$.metadata.name"
      - key: "s"
        name: "Services"
        description: "View services in namespace"
        page: services
        context:
          namespace: "$.metadata.name"

  # ============================================================================
  # PODS - List pods in selected namespace
  # ============================================================================
  pods:
    title: "Pods - {{ namespaces.metadata.name }}"
    description: "List all pods in namespace"
    data:
      type: cli
      command: "kubectl"
      args:
        ["get", "pods", "-n", "{{ namespaces.metadata.name }}", "-o", "json"]
      items: "$.items[*]"
      timeout: "30s"
      refresh_interval: "5s"
    view:
      type: table
      columns:
        - path: "$.metadata.name"
          display: "Name"
        - path: "$.status.phase"
          display: "Status"
        - path: "$.status.conditions[?(@.type=='Ready')].status"
          display: "Ready"
        - path: "$.spec.containers[*].name"
          display: "Containers"
          transform: "{{ value | length }}"
        - path: "$.status.containerStatuses[?(@.ready==true)]"
          display: "Ready/Total"
          transform: "{{ value | length }}/{{ value | length }}"
        - path: "$.metadata.creationTimestamp"
          display: "Age"
          transform: "{{ value | timeago }}"
    next:
      page: pod_detail
      context:
        pod_name: "$.metadata.name"
        namespace: "{{ namespaces.metadata.name }}"
    actions:
      - key: "l"
        name: "Logs"
        description: "View pod logs"
        page: pod_logs
        context:
          pod_name: "$.metadata.name"
          namespace: "{{ namespaces.metadata.name }}"
      - key: "d"
        name: "Delete"
        description: "Delete pod"
        confirm: "Delete pod {{ metadata.name }}?"
        command: "kubectl"
        args:
          [
            "delete",
            "pod",
            "{{ metadata.name }}",
            "-n",
            "{{ namespaces.metadata.name }}",
          ]
        notification:
          on_success: "Pod '{{ metadata.name }}' deleted successfully"
          on_failure: "Failed to delete pod '{{ metadata.name }}'"
        refresh: true
      - key: "e"
        name: "Describe"
        description: "Describe pod"
        page: pod_describe

  # ============================================================================
  # POD DETAIL - Show detailed information about a pod
  # ============================================================================
  pod_detail:
    title: "Pod - {{ pods.metadata.name }}"
    description: "Detailed pod information"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "get",
          "pod",
          "{{ pods.metadata.name }}",
          "-n",
          "{{ namespaces.metadata.name }}",
          "-o",
          "yaml",
        ]
      items: "@this"
      timeout: "30s"
    view:
      type: text
      syntax: yaml
      line_numbers: true
    actions:
      - key: "l"
        name: "Logs"
        description: "View logs"
        page: pod_logs
      - key: "y"
        name: "YAML"
        description: "View raw YAML"
        builtin: yaml_view

  # ============================================================================
  # POD LOGS - Stream pod logs (Phase 2 - using detail view for now)
  # ============================================================================
  pod_logs:
    title: "Logs - {{ pods.metadata.name }}"
    description: "Pod logs (streaming)"
    data:
      type: stream
      command: "kubectl"
      args:
        [
          "logs",
          "-f",
          "{{ pods.metadata.name }}",
          "-n",
          "{{ namespaces.metadata.name }}",
          "--tail=100",
        ]
      buffer_size: 100
      buffer_time: "15m"
      follow: true
    view:
      type: logs
      follow: true
      wrap: true
      show_timestamps: false

  # ============================================================================
  # POD DESCRIBE - kubectl describe output
  # ============================================================================
  pod_describe:
    title: "Describe - {{ pods.metadata.name }}"
    description: "kubectl describe output"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "describe",
          "pod",
          "{{ pods.metadata.name }}",
          "-n",
          "{{ namespaces.metadata.name }}",
        ]
      items: "@this"
      timeout: "30s"
    view:
      type: text
      line_numbers: true

  # ============================================================================
  # DEPLOYMENTS - List deployments in namespace
  # ============================================================================
  deployments:
    title: "Deployments - {{ namespaces.metadata.name }}"
    description: "List all deployments"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "get",
          "deployments",
          "-n",
          "{{ namespaces.metadata.name }}",
          "-o",
          "json",
        ]
      items: "$.items[*]"
      timeout: "30s"
      refresh_interval: "10s"
    view:
      type: table
      columns:
        - path: "$.metadata.name"
          display: "Name"
        - path: "$.spec.replicas"
          display: "Desired"
        - path: "$.status.availableReplicas"
          display: "Available"
        - path: "$.status.readyReplicas"
          display: "Ready"
        - path: "$.status.updatedReplicas"
          display: "Updated"
        - path: "$.metadata.creationTimestamp"
          display: "Age"
          transform: "{{ value | timeago }}"
    next:
      page: deployment_detail
      context:
        deployment_name: "$.metadata.name"
    actions:
      - key: "s"
        name: "Scale"
        description: "Scale deployment"
        command: "kubectl"
        args:
          [
            "scale",
            "deployment",
            "{{ metadata.name }}",
            "-n",
            "{{ namespaces.metadata.name }}",
            "--replicas=3",
          ]
        confirm: "Scale {{ metadata.name }} to 3 replicas?"
        success_message: "Scaled {{ metadata.name }}"
        refresh: true
      - key: "r"
        name: "Restart"
        description: "Restart deployment"
        command: "kubectl"
        args:
          [
            "rollout",
            "restart",
            "deployment",
            "{{ metadata.name }}",
            "-n",
            "{{ namespaces.metadata.name }}",
          ]
        confirm: "Restart {{ metadata.name }}?"
        success_message: "Restarted {{ metadata.name }}"
        refresh: true
      - key: "d"
        name: "Delete"
        description: "Delete deployment"
        confirm: "Delete deployment {{ metadata.name }}?"
        command: "kubectl"
        args:
          [
            "delete",
            "deployment",
            "{{ metadata.name }}",
            "-n",
            "{{ namespaces.metadata.name }}",
          ]
        success_message: "Deleted {{ metadata.name }}"
        error_message: "Failed to delete"
        refresh: true

  # ============================================================================
  # DEPLOYMENT DETAIL - Show deployment details
  # ============================================================================
  deployment_detail:
    title: "Deployment - {{ deployments.metadata.name }}"
    description: "Deployment details"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "get",
          "deployment",
          "{{ deployments.metadata.name }}",
          "-n",
          "{{ namespaces.metadata.name }}",
          "-o",
          "json",
        ]
      items: "@this"
      timeout: "30s"
    view:
      type: text
      syntax: json
      line_numbers: true
    actions:
      - key: "p"
        name: "Pods"
        description: "View pods for this deployment"
        page: deployment_pods

  # ============================================================================
  # DEPLOYMENT PODS - Show pods for a deployment
  # ============================================================================
  deployment_pods:
    title: "Pods - {{ deployments.metadata.name }}"
    description: "Pods managed by deployment"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "get",
          "pods",
          "-n",
          "{{ namespaces.metadata.name }}",
          "-l",
          "app={{ deployments.metadata.labels.app }}",
          "-o",
          "json",
        ]
      items: "$.items[*]"
      timeout: "30s"
    view:
      type: table
      columns:
        - path: "$.metadata.name"
          display: "Name"
        - path: "$.status.phase"
          display: "Status"
        - path: "$.metadata.creationTimestamp"
          display: "Age"
          transform: "{{ value | timeago }}"
    next:
      page: pod_detail
      context:
        pod_name: "$.metadata.name"

  # ============================================================================
  # SERVICES - List services in namespace
  # ============================================================================
  services:
    title: "Services - {{ namespaces.metadata.name }}"
    description: "List all services"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "get",
          "services",
          "-n",
          "{{ namespaces.metadata.name }}",
          "-o",
          "json",
        ]
      items: "$.items[*]"
      timeout: "30s"
    view:
      type: table
      columns:
        - path: "$.metadata.name"
          display: "Name"
        - path: "$.spec.type"
          display: "Type"
        - path: "$.spec.clusterIP"
          display: "Cluster IP"
        - path: "$.spec.ports[*].port"
          display: "Ports"
        - path: "$.metadata.creationTimestamp"
          display: "Age"
          transform: "{{ value | timeago }}"
    next:
      page: service_detail
      context:
        service_name: "$.metadata.name"
    actions:
      - key: "d"
        name: "Delete"
        description: "Delete service"
        confirm: "Delete service {{ metadata.name }}?"
        command: "kubectl"
        args:
          [
            "delete",
            "service",
            "{{ metadata.name }}",
            "-n",
            "{{ namespaces.metadata.name }}",
          ]
        success_message: "Deleted service {{ metadata.name }}"
        refresh: true

  # ============================================================================
  # SERVICE DETAIL - Show service details
  # ============================================================================
  service_detail:
    title: "Service - {{ services.metadata.name }}"
    description: "Service details"
    data:
      type: cli
      command: "kubectl"
      args:
        [
          "get",
          "service",
          "{{ services.metadata.name }}",
          "-n",
          "{{ namespaces.metadata.name }}",
          "-o",
          "yaml",
        ]
      items: "@this"
      timeout: "30s"
    view:
      type: text
      syntax: yaml
      line_numbers: true
